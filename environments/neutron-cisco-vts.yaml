# A Heat environment file which can be used to enable Cisco VTS extensions, configured via puppet

# By default the configuration has items required to deploy VPP/VPFA on all nodes + the cisco ML2 VTS driver

resource_registry:
  OS::TripleO::Services::NeutronCorePlugin: OS::TripleO::Services::NeutronCorePluginVTS

  #Comment out below line when deploying VTS Agent on compute nodes instead of VPP/VPFA
  OS::TripleO::Services::ComputeNeutronCorePlugin: OS::Heat::None

  # Disable Neutron L3 agent that conflict with VPFA
  OS::TripleO::Services::NeutronL3Agent: OS::Heat::None

  ## OVS and VTS Agent section

  # Disable/enable the default OVS Agent for compute and controller
  OS::TripleO::Services::ComputeNeutronOvsAgent: OS::Heat::None
  OS::TripleO::Services::NeutronOvsAgent: OS::Heat::None

  ## Disable/enable VTS agent service. VTS agent and OVS agent are mutually exclusive
  # NOTE: The OS::TripleO::Services::VTSAgent needs to be added to the deployment role file
  #OS::TripleO::Services::VTSAgent: ../puppet/services/neutron-cisco-vts-agent.yaml

  ## VPFA Configuration Hook scripts
  OS::TripleO::ComputeExtraConfigPre: /usr/share/openstack-tripleo-heat-templates/puppet/extraconfig/pre_deploy/cisco_vts_vpfa.yaml

  # Additional hook scripts for controller. Enable/disable as disctated by the scope of the deployment
  OS::TripleO::ControllerExtraConfigPre: /usr/share/openstack-tripleo-heat-templates/puppet/extraconfig/pre_deploy/cisco_vts_vpfa.yaml

  # Same hook scripts as above for all nodes in one. Enable/disable as disctated by the scope of the deployment.
  #OS::TripleO::NodeExtraConfig: /usr/share/openstack-tripleo-heat-templates/puppet/extraconfig/pre_deploy/cisco_vts_vpfa.yaml

  ## Rsyslog client
  OS::TripleO::Services::RSyslogClient: ../puppet/services/rsyslog-client.yaml


parameter_defaults:

  ###################
  ### VTS General ###
  ###################

  VTSUsername: 'admin'
  VTSPassword: ''
  VTSServer: '192.168.0.1'
  VTSVMMID: ''

  ###################
  ### Neutron ML2 ###
  ###################

  NeutronCorePlugin: 'neutron.plugins.ml2.plugin.Ml2Plugin'
  NeutronMechanismDrivers: 'sriovnicswitch,cisco_vts'
  NeutronTypeDrivers: 'vxlan,vlan,flat'
  NeutronServicePlugins: 'cisco_vts_router,trunk'

  ## DHCP Agent interface driver. Uncomment ONLY if/when deploying VPP on the controller node(s).
  #NeutronInterfaceDriver: 'cisco_controller.drivers.agent.linux.interface.NamespaceDriver'

  ########################
  ### VTS Agent Config ###
  ########################

  VTSPhysicalNet: ''
  #VTSRetries: 15
  #VTSTimeout:
  #VTSPollingInterval: 6

  ###################
  ### VPFA Config ###
  ###################

  UnderlayIpNewtorksList: '11.0.0.1/24'
  VTSRIpAddressList: '10.0.0.1'
  #VPFAHostname: 'foo'
  #NetworkConfigMethod: 'static'
  #NetworkNameServerIP: ''
  #VifTypeCompute: 'vhostuser'
  #VifTypeController: 'tap'

  # Set common VTS Network Gateway address or set/override it in PerNodeData below
  #VTSNetworkIPv4Gateway: '10.0.0.1'


  # VPFA Configuration requires the assignment of an underlay IP address for the VPFA per node.
  # This needs to be specified against the UUID of the target node in a JSON data blob.
  # To derive the UUID, after node introspection execute the following CLI command steps:
  #
  # 1. 'ironic node-list'. Note Openstack ID of the target node
  # 2. 'openstack baremetal introspection data save <Openstack ID from step1> | jq .extra.system.product.uuid
  # 3. Note the Node UUID and use it in the json configuration blob below. Multiple nodes can be specified.
  #
  # The per-node data can be used to set/override any of the cisco_vpfa:: module configuration parameters
  #
  PerNodeData: |
    {
      "< Node1 UUID >": {
          "cisco_vpfa::vtf_underlay_ip_v4": "10.0.0.2",
          "cisco_vpfa::vtf_underlay_mask_v4": "24",
          "cisco_vpfa::network_ipv4_gateway": "10.0.0.1"},
      "< Node2 UUID >": {
          "cisco_vpfa::vtf_underlay_ip_v4": "10.0.0.3",
          "cisco_vpfa::vtf_underlay_mask_v4": "24",
          "cisco_vpfa::network_ipv4_gateway": "10.0.0.1"}
    }

  ###################
  ### VPP Config  ###
  ###################

  #The CPUs listed below need to be part of the grub isol CPU list (configured elsewhere)

  #VppCpuMainCoreController: '0'
  #VppCpuCorelistWorkersController: ''
  #VppCpuMainCoreCompute: '0'
  #VppCpuCorelistWorkersCompute: ''

  #####################################
  ### rSyslog Client Configuration  ###
  #####################################
  # NOTE: Add OS::TripleO::Services::RSyslogClient to the role data catalogue for the service to come into effect

  # ****** SET THE CORRECT SYSLOG SERVER IP ADDRESS IN ClientLogFilters! *******

  # Cisco VPFA default log and priority settings
  ImFiles: |
   {
    "error": {
      "file_name": "/var/log/vpfa/vpfa_server_errors.log",
      "file_tag": "vpfa",
      "file_severity": "err",
      "file_facility": "local3"
      },
    "warning": {
      "file_name": "/var/log/vpfa/vpfa_server_warning.log",
      "file_tag": "vpfa",
      "file_severity": "warning",
      "file_facility": "local3"
      },
     "critical": {
      "file_name": "/var/log/vpfa/vpfa_server_critical.log",
      "file_tag": "vpfa",
      "file_severity": "critical",
      "file_facility": "local3"
      }
    }
  ClientLogTemplates: |
    [
      {
        "name": "forwardFormat",
        "template": "type=\"string\" string=\"<%PRI%>%TIMESTAMP:::date-rfc3339% %HOSTNAME% %syslogtag:1:32%%msg:::sp-if-no-1st-sp%%msg%\""
      }
    ]


  ClientLogFilters: |
    [
      {
        "expression": "$syslogfacility-text == 'local3' and $syslogseverity-text == 'crit'",
        "action": "@@[19.0.128.2]:514;forwardFormat"
      },
      {
        "expression": "$syslogfacility-text == 'local3' and $syslogseverity-text == 'err'",
        "action": "@@[19.0.128.2]:514;forwardFormat"
      },
      {
        "expression": "$syslogfacility-text == 'local3' and $syslogseverity-text == 'warning'",
        "action": "@@[19.0.128.2]:514;forwardFormat"
      },
      {
        "expression": "$syslogfacility-text == 'local3' and $syslogseverity-text == 'crit'",
        "action": "@[19.0.128.1]:514;forwardFormat"
      },
      {
        "expression": "$syslogfacility-text == 'local3' and $syslogseverity-text == 'err'",
        "action": "@[19.0.128.1]:514;forwardFormat"
      }
    ]


  # Use the RemoteServers JSON parameter for configuring remote servers. The JSON data is meant to be an array of
  # dicts (hashes), with each array item corresponding to a server. RemoteServers overrides SyslogServer
  # See https://github.com/saz/puppet-rsyslog for list of supported dict(hash) keys.
  # Eg: RemoteServers: |
  #    [
  #      {"host" : "logs.example.org",
  #      "port" : "55514",
  #      "pattern" : "*.log"}
  #    ]
  #RemoteServers: |
  #  [
  #    {}
  #  ]
  # Config options for single simple server, client filters and imfiles.
  #SyslogServer: ''
  #RemoteForwardFormat: ''
  #ClientLogFilters: ''

  # Imfiles configuration JSON data. See https://github.com/saz/puppet-rsyslog for list of parameters
  # Eg: ImFiles: |
  #[
  #      {
  #      "file_name" : "/var/log/*",
  #      "file_tag" : "my_tag",
  #      "file_facility" : "myfacility"
  #      }
  #    ]


  #The LogTemplates JSON data parameter can be used to set up custom logging templates, which can be used for local
  #and/or remote logging. More detail on template formats can be found in the [rsyslog documentation]
  #(http://www.rsyslog.com/doc/rsyslog_conf_templates.html
  #ClientLogTemplates: |
  #  [
  #    {}
  #  ]

  #ClientSnippet: |
  #  {
  #    "cisco_vpfa": {
  #      "content": "abdcef"
  #      }
  #  }

  #########################################################
  ### Special VPP Config - Not intended for general use ###
  #########################################################

  # Flag to control generation of VPP config. Set to "False" if using the OSPD VPP Module and os-net-config.
  VPFAInit: "False"

  # If above flag is set to True, the following parameters MUST be passed.
  #UnderlayInterface: 'ens224'
  #BondIfList: ''

  # When VPFAInit is set to true, the following VPP parameters need to be provided by means
  # of a json data e.g:
  #
  #VPPparams: |
  #  {"RECONFIGURE": "False",
  #  "ENABLE_VPP_WORKERS": "False",
  #  "ENABLE_JUMBO_FRAMES": "True",
  #  "ENABLE_LLDP": "True",
  #  "MAX_MTU_SIZE": "9000",
  #  "HEADERS_FOR_VPP": "64",
  #  "PCI_DRIVER": "uio_pci_generic",
  #  "HOSTCPUS": "2",
  #  "VIF_TYPE": "vhostuser",
  #  "VPPCPUS": "1",
  #  "L2_MODE": "True"}
